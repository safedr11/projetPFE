<div *ngIf="loading" class="loading-spinner">
  <mat-spinner></mat-spinner>
</div>

<div *ngIf="!loading && demande" class="demande-details-container">
  <h2>Prise de Décision</h2>

  <!-- Section Informations de base -->
  <mat-card class="section-card">
    <mat-card-header>
      <mat-card-title>Informations de base</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="detail-row">
        <span class="detail-label">Demandeur:</span>
        <mat-form-field appearance="outline">
          <input matInput [(ngModel)]="demande.demandeur" />
        </mat-form-field>
      </div>
      <div class="detail-row">
        <span class="detail-label">Client:</span>
        <mat-form-field appearance="outline">
          <input matInput [(ngModel)]="demande.client" />
        </mat-form-field>
      </div>
      <div class="detail-row">
        <span class="detail-label">Source de changement:</span>
        <mat-form-field appearance="outline">
          <input matInput [(ngModel)]="demande.sourceDeChangement" />
        </mat-form-field>
      </div>
      <div class="detail-row">
        <span class="detail-label">Description:</span>
        <mat-form-field appearance="outline">
          <textarea matInput [(ngModel)]="demande.description"></textarea>
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Section Étude de la demande -->
  <mat-card class="section-card">
    <mat-card-header>
      <mat-card-title>Étude de la demande</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="detail-row">
        <span class="detail-label">Service(s) impacté(s):</span>
        <mat-form-field appearance="outline">
          <input matInput [(ngModel)]="demande.impactedInfrastructure" />
        </mat-form-field>
      </div>
      <div class="detail-row">
        <span class="detail-label">Niveau d'impact:</span>
        <mat-form-field appearance="outline">
          <mat-select [(ngModel)]="demande.niveauImpact">
            <mat-option *ngFor="let impact of ['Majeur', 'Mineur', 'Modéré']" [value]="impact">
              {{ impact }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="detail-row">
        <span class="detail-label">Priorité:</span>
        <mat-form-field appearance="outline">
          <mat-select [(ngModel)]="demande.priorite">
            <mat-option *ngFor="let priority of ['Haute', 'Moyenne', 'Basse']" [value]="priority">
              {{ priority }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="detail-row">
        <span class="detail-label">Catégorie:</span>
        <mat-form-field appearance="outline">
          <mat-select [(ngModel)]="demande.categorie">
            <mat-option *ngFor="let categorie of ['Mineur', 'Significatif', 'Majeur']" [value]="categorie">
              {{ categorie }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Section Ressources -->
  <mat-card class="section-card" *ngIf="demande.ressources">
    <mat-card-header>
      <mat-card-title>Ressources nécessaires</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="detail-row">
        <span class="detail-label">Ressources humaines:</span>
        <mat-form-field appearance="outline">
          <input matInput [(ngModel)]="demande.ressources.humanResources" />
        </mat-form-field>
      </div>
      <div class="detail-row">
        <span class="detail-label">Ressources matérielles:</span>
        <mat-form-field appearance="outline">
          <input matInput [(ngModel)]="demande.ressources.materialResources" />
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Section Évaluation des risques -->
  <mat-card class="section-card" *ngIf="demande.riskAssessment">
    <mat-card-header>
      <mat-card-title>Évaluation des risques</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <!-- Disponibilité -->
      <div *ngIf="demande.riskAssessment.disponibilite" class="risk-section">
        <h3>Disponibilité</h3>
        <div class="detail-row">
          <span class="detail-label">Description:</span>
          <mat-form-field appearance="outline">
            <textarea matInput [(ngModel)]="demande.riskAssessment.disponibilite.description"></textarea>
          </mat-form-field>
        </div>
        <div class="detail-row">
          <span class="detail-label">Impact:</span>
          <mat-form-field appearance="outline">
            <input matInput [(ngModel)]="demande.riskAssessment.disponibilite.impactValue" />
          </mat-form-field>
        </div>
        <div class="detail-row">
          <span class="detail-label">Probabilité:</span>
          <mat-form-field appearance="outline">
            <input matInput [(ngModel)]="demande.riskAssessment.disponibilite.probability" />
          </mat-form-field>
        </div>
        <div class="detail-row">
          <span class="detail-label">Criticité:</span>
          <mat-form-field appearance="outline">
            <input matInput [(ngModel)]="demande.riskAssessment.disponibilite.criticity" />
          </mat-form-field>
        </div>
        <div class="detail-row">
          <span class="detail-label">Commentaires RSSI:</span>
          <mat-form-field appearance="outline">
            <textarea matInput [(ngModel)]="demande.riskAssessment.disponibilite.rssiComments"></textarea>
          </mat-form-field>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Section Actions techniques -->
  <mat-card class="section-card" *ngIf="demande.technicalActions && demande.technicalActions.length > 0">
    <mat-card-header>
      <mat-card-title>Actions techniques</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <mat-accordion>
        <mat-expansion-panel *ngFor="let action of demande.technicalActions">
          <mat-expansion-panel-header>
            <mat-panel-title>
              Action #{{ action.actionNumber }} - {{ action.description }}
            </mat-panel-title>
            <mat-panel-description>
              Statut: {{ action.status }}
            </mat-panel-description>
          </mat-expansion-panel-header>
          <div class="detail-row">
            <span class="detail-label">Responsable:</span>
            <mat-form-field appearance="outline">
              <input matInput [(ngModel)]="action.responsable" />
            </mat-form-field>
          </div>
          <div class="detail-row">
            <span class="detail-label">Date planifiée:</span>
            <mat-form-field appearance="outline">
              <input matInput [(ngModel)]="action.plannedDate" type="date" />
            </mat-form-field>
          </div>
          <div class="detail-row">
            <span class="detail-label">Type d'action:</span>
            <mat-form-field appearance="outline">
              <input matInput [(ngModel)]="action.actionType" />
            </mat-form-field>
          </div>
          <div class="detail-row">
            <span class="detail-label">Commentaires:</span>
            <mat-form-field appearance="outline">
              <textarea matInput [(ngModel)]="action.comments"></textarea>
            </mat-form-field>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
    </mat-card-content>
  </mat-card>

  <!-- Boutons Valider et Rejeter -->
  <div class="actions-container">
    <button mat-raised-button color="primary" (click)="approveDemande()">Valider</button>
    <button mat-raised-button color="warn" (click)="rejectDemande()">Rejeter</button>
  </div>

  <!-- Bouton Retour -->
  <div class="actions-container">
    <button mat-raised-button color="primary" (click)="goBack()">Retour</button>
  </div>
</div>
